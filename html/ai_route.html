<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>路徑推薦 - 碳 Bee</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { 
            --primary: #10b981; 
            --primary-light: #d1fae5; 
            --bg: #f0fdf4; 
            --success: #059669; 
            --dark: #064e3b; 
        }

        body { 
            font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; 
            background: linear-gradient(180deg, #bbf7d0 0%, #f0fdf4 400px, #f0fdf4 100%);
            background-attachment: fixed;
            margin: 0; padding: 0; min-height: 100vh; color: var(--dark);
        }

        #site-nav { position: fixed; top: 0; left: 0; width: 100%; z-index: 9999; }

        .app-card { 
            background: rgba(255, 255, 255, 0.95); 
            backdrop-filter: blur(15px); 
            width: 90%; max-width: 1100px; 
            padding: 35px; border-radius: 28px; 
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.05); 
            margin: 100px auto 40px auto; 
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-sizing: border-box; /* 確保 padding 不會撐爆寬度 */
        }

        h1 { text-align: center; font-weight: 800; margin-bottom: 30px; border-bottom: 2px solid var(--primary-light); padding-bottom: 15px; }

        /* 輸入區 RWD 調整 */
        .input-section { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 20px; 
            margin-bottom: 30px; 
        }
        
        .control-group { background: rgba(255, 255, 255, 0.5); padding: 20px; border-radius: 20px; border: 1px solid var(--primary-light); }
        
        label { display: block; font-weight: bold; margin-bottom: 8px; color: var(--dark); }
        
        input[type="text"], select { 
            width: 100%; padding: 12px; border: 1px solid #d1fae5; border-radius: 12px; 
            box-sizing: border-box; background: rgba(255, 255, 255, 0.8); font-size: 1rem; color: var(--dark);
        }

        .route-details { margin-top: 8px; display: flex; align-items: center; flex-wrap: wrap; gap: 6px; font-size: 0.85rem; }
        .seg-tag { background: var(--primary-light); padding: 3px 10px; border-radius: 8px; color: var(--dark); display: flex; align-items: center; gap: 5px; margin-bottom: 4px; }
        .seg-arrow { color: var(--primary); font-size: 10px; opacity: 0.6; }

        /* 表格與卡片切換樣式 */
        table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 20px; font-size: 14px; }
        th, td { padding: 16px 12px; text-align: left; border-bottom: 1px solid #ecfdf5; vertical-align: top; }
        th { background: #f0fdf4; color: var(--dark); font-weight: 700; }
        
        .recommended-badge { background: var(--primary); color: white; padding: 3px 10px; border-radius: 20px; font-size: 11px; margin-left: 8px; white-space: nowrap; }
        .coin-plus { color: var(--primary); font-weight: 800; }
        .score-info { font-size: 11px; color: #64748b; margin-top: 4px; white-space: nowrap; }

        /* --- 手機版 RWD (關鍵修改) --- */
        @media (max-width: 768px) {
            .app-card { padding: 20px; margin-top: 80px; width: 95%; }
            
            .input-section { grid-template-columns: 1fr; gap: 10px; }
            .control-group { padding: 15px; }

            /* 強制將表格變成卡片列表 */
            table, thead, tbody, th, td, tr { display: block; }
            thead tr { position: absolute; top: -9999px; left: -9999px; } /* 隱藏表頭 */
            
            tr { 
                background: white; 
                border: 1px solid #e5e7eb; 
                border-radius: 12px; 
                margin-bottom: 15px; 
                padding: 15px;
                box-shadow: 0 2px 5px rgba(0,0,0,0.02);
            }

            td { 
                border: none; 
                padding: 5px 0; 
                position: relative; 
                display: flex; /* 讓 label 和 content 並排 */
                justify-content: space-between;
                align-items: flex-start;
                text-align: right;
            }

            /* 手機版顯示欄位名稱 (Label) */
            td:before { 
                content: attr(data-label); 
                font-weight: bold; 
                color: var(--dark);
                margin-right: 15px;
                text-align: left;
                flex-shrink: 0; /* 防止 label 被擠壓 */
            }

            /* 第一欄 (方案名稱) 特殊處理：置頂且大字 */
            td:first-child { 
                display: block; 
                text-align: left; 
                font-size: 1.1rem; 
                margin-bottom: 10px; 
                border-bottom: 1px dashed #eee; 
                padding-bottom: 10px;
            }
            td:first-child:before { display: none; } /* 第一欄不顯示 label */
            
            .route-details { margin-top: 10px; }
            .seg-tag { display: inline-flex; } /* 改回 inline-flex 以便斷行 */
        }
    </style>
</head>
<body>

<div id="site-nav"></div>
<script src="../js/nav.js"></script>

<div class="app-card">
    <h1><i class="fas fa-route"></i>路線推薦</h1>
    
    <div class="input-section">
        <div class="control-group">
            <label>設定通勤路線</label>
            <input type="text" id="startPoint" placeholder="起點" value="台北車站">
            <input type="text" id="endPoint" placeholder="終點" value="台灣大學" oninput="updateUI()">
        </div>

        <div class="control-group">
            <label>排序方式 (選擇優先項目)</label>
            <select id="sortCriteria" onchange="updateUI()">
                <option value="totalScore">綜合評分 </option>
                <option value="s_time">時間效率分數 </option>
                <option value="s_cost">費用經濟分數 </option>
                <option value="s_carbon">減碳效益分數 </option>
            </select>
        </div>
    </div>

    <div id="resultsArea">
        <table>
            <thead>
                <tr>
                    <th width="40%">推薦方案與詳細路段</th>
                    <th>時間 / 費用</th>
                    <th>減碳量 / 碳幣</th>
                    <th>各項得分詳情</th>
                    <th>綜合評分</th>
                </tr>
            </thead>
            <tbody id="resultBody"></tbody>
        </table>
    </div>
</div>

<script>
// 1. 係數定義 (新增 HSR:高鐵)
const EF_TABLE = { 
    "BUS": 0.040, "MRT": 0.040, "TRAIN": 0.060, "HSR": 0.038,
    "TAXI": 0.133, "CAR": 0.115, "MOTO": 0.0951, "WALK": 0.000 
};
// 新增 HSR 圖示
const ICONS = { "MRT": "subway", "BUS": "bus", "WALK": "walking", "CAR": "car", "TRAIN": "train", "HSR": "train-subway", "TAXI": "taxi", "MOTO": "motorcycle" };

// 2. 路線資料庫 (保留舊的 + 新增6條)
const routesData = {
    // === 原有路線保留 ===
    "TPE_101": { dist: 6.5, options: [
        { name: "捷運紅線直達", segments: [{ type: "MRT", desc: "紅線 (北車-101/世貿)", time: 17, cost: 25 }, { type: "WALK", desc: "步行至 101", time: 4, cost: 0 }] },
        { name: "捷運藍線轉步行", segments: [{ type: "MRT", desc: "藍線 (北車-市政府)", time: 10, cost: 20 }, { type: "WALK", desc: "步行 1.1 公里", time: 15, cost: 0 }] },
        { name: "計程車方案", segments: [{ type: "TAXI", desc: "經信義路", time: 18, cost: 220 }] }
    ]},
    "TPE_RAOHE": { dist: 7.2, options: [
        { name: "台鐵快線方案", segments: [{ type: "TRAIN", desc: "台鐵 (台北-松山)", time: 8, cost: 22 }, { type: "WALK", desc: "步行至饒河街", time: 4, cost: 0 }] },
        { name: "捷運方案", segments: [{ type: "MRT", desc: "綠線至松山站", time: 20, cost: 25 }, { type: "WALK", desc: "步行", time: 4, cost: 0 }] }
    ]},
    "TPE_NTU": { dist: 5.2, options: [
        { name: "捷運複合方案", segments: [{ type: "MRT", desc: "紅線 (北車-中正)", time: 6, cost: 25 }, { type: "WALK", desc: "轉乘", time: 2, cost: 0 }, { type: "MRT", desc: "綠線 (中正-公館)", time: 5, cost: 0 }, { type: "WALK", desc: "步行至校門", time: 12, cost: 0 }] },
        { name: "直達公車方案", segments: [{ type: "WALK", desc: "走至站牌", time: 5, cost: 0 }, { type: "BUS", desc: "羅幹線", time: 25, cost: 15 }, { type: "WALK", desc: "步行至校門", time: 5, cost: 0 }] }
    ]},

    // === 新增路線 ===
    // 1. 西門町 (Ximen)
    "TPE_XIMEN": { dist: 2.2, options: [
        { name: "方案 A (捷運+步行)", segments: [{ type: "MRT", desc: "板南線 (北車-西門)", time: 2, cost: 20 }, { type: "WALK", desc: "步行至紅樓", time: 4, cost: 0 }] },
        { name: "方案 B (公車)", segments: [{ type: "WALK", desc: "步行", time: 1, cost: 0 }, { type: "BUS", desc: "218路", time: 4, cost: 15 }, { type: "WALK", desc: "步行", time: 5, cost: 0 }] },
        { name: "方案 C (公車)", segments: [{ type: "WALK", desc: "步行", time: 1, cost: 0 }, { type: "BUS", desc: "310路", time: 5, cost: 15 }, { type: "WALK", desc: "步行", time: 5, cost: 0 }] }
    ]},
    // 2. 士林夜市 (Shilin)
    "TPE_SHILIN": { dist: 5.2, options: [
        { name: "方案 A (捷運)", segments: [{ type: "MRT", desc: "淡水信義線 (北車-劍潭)", time: 8, cost: 20 }, { type: "WALK", desc: "步行至夜市", time: 6, cost: 0 }] },
        { name: "方案 B (公車)", segments: [{ type: "WALK", desc: "步行", time: 4, cost: 0 }, { type: "BUS", desc: "260路", time: 18, cost: 15 }, { type: "WALK", desc: "步行", time: 7, cost: 0 }] }
    ]},
    // 3. 淡水老街 (Tamsui)
    "TPE_TAMSUI": { dist: 22.3, options: [
        { name: "方案 A (捷運)", segments: [{ type: "MRT", desc: "淡水信義線 (北車-淡水)", time: 39, cost: 50 }, { type: "WALK", desc: "步行至老街", time: 4, cost: 0 }] },
        { name: "方案 B (公車轉乘)", segments: [{ type: "WALK", desc: "步行", time: 7, cost: 0 }, { type: "BUS", desc: "756路", time: 55, cost: 15 }, { type: "WALK", desc: "步行", time: 3, cost: 0 }] }
    ]},
    // 4. 南港展覽館 (Nangang)
    "TPE_NANGANG": { dist: 13.5, options: [
        { name: "方案 A (捷運)", segments: [{ type: "MRT", desc: "板南線(北車-南港展覽館)", time: 22, cost: 30 }, { type: "WALK", desc: "步行", time: 2, cost: 0 }] },
        { name: "方案 B (台鐵)", segments: [{ type: "TRAIN", desc: "區間車 (台北-南港)", time: 10, cost: 22 }, { type: "WALK", desc: "步行", time: 17, cost: 0 }] },
        { name: "方案 C (高鐵)", segments: [{ type: "HSR", desc: "高鐵", time: 8, cost: 40 }, { type: "WALK", desc: "步行", time: 17, cost: 0 }] }
    ]},
    // 5. 內湖科學園區 (Neihu)
    "TPE_NEIHU": { dist: 11.0, options: [
        { name: "方案 A (捷運轉乘)", segments: [{ type: "MRT", desc: "板南線 (北車-忠孝復興)", time: 6, cost: 20 }, { type: "WALK", desc: "步行", time: 3, cost: 0 }, { type: "MRT", desc: "文湖線 (忠孝復興-西湖)", time: 16, cost: 30 }, { type: "WALK", desc: "步行", time: 13, cost: 0 }] },
        { name: "方案 B (公車)", segments: [{ type: "WALK", desc: "步行", time: 7, cost: 0 }, { type: "BUS", desc: "內湖幹線", time: 31, cost: 30 }, { type: "WALK", desc: "步行", time: 6, cost: 0 }] },
        { name: "方案 C (捷運+公車)", segments: [{ type: "MRT", desc: "板南線 (北車-市政府)", time: 11, cost: 20 }, { type: "WALK", desc: "步行", time: 3, cost: 0 }, { type: "BUS", desc: "522路", time: 15, cost: 15 }, { type: "WALK", desc: "步行", time: 3, cost: 0 }] }
    ]},
    // 6. 台北市政府 (City Hall)
    "TPE_CITYHALL": { dist: 5.0, options: [
        { name: "方案 A (捷運)", segments: [{ type: "MRT", desc: "板南線 (北車-市政府)", time: 10, cost: 20 }, { type: "WALK", desc: "步行", time: 6, cost: 0 }] },
        { name: "方案 B (公車)", segments: [{ type: "WALK", desc: "步行", time: 4, cost: 0 }, { type: "BUS", desc: "669路", time: 25, cost: 15 }, { type: "WALK", desc: "步行", time: 4, cost: 0 }] }
    ]}
};

function getRouteKey(target) {
    const t = target.toLowerCase();
    
    // 1. 台北 101
    if (t.includes("101") || t.includes("世貿") || t.includes("信義")) return "TPE_101";
    // 2. 饒河夜市
    if (t.includes("饒河") || t.includes("松山")) return "TPE_RAOHE";
    // 3. 西門町
    if (t.includes("西門") || t.includes("紅樓")) return "TPE_XIMEN";
    // 4. 士林夜市
    if (t.includes("士林") || t.includes("劍潭")) return "TPE_SHILIN";
    // 5. 淡水老街
    if (t.includes("淡水") || t.includes("老街")) return "TPE_TAMSUI";
    // 6. 南港展覽館
    if (t.includes("南港") || t.includes("展覽館")) return "TPE_NANGANG";
    // 7. 內湖科學園區
    if (t.includes("內湖") || t.includes("科學園區") || t.includes("內科")) return "TPE_NEIHU";
    // 8. 台北市政府
    if (t.includes("市政府") || t.includes("市府")) return "TPE_CITYHALL";

    // 預設台大
    return "TPE_NTU"; 
}

function updateUI() {
    const sortCriteria = document.getElementById('sortCriteria').value;
    const endPointValue = document.getElementById('endPoint').value;
    const route = routesData[getRouteKey(endPointValue)];
    
    let processedData = route.options.map(opt => {
        let t_time = 0, t_cost = 0, t_emission = 0;
        opt.segments.forEach(seg => {
            t_time += seg.time;
            t_cost += seg.cost;
            let seg_dist = (seg.time / 30) * route.dist; 
            t_emission += seg_dist * EF_TABLE[seg.type];
        });

        const e_car_ref = route.dist * 0.115; 
        const carbonSaved = e_car_ref - t_emission;

        const s_time = Math.max(0, 100 - t_time);
        const s_cost = Math.max(0, 100 - t_cost);
        const s_carbon = Math.min(100, carbonSaved * 100);

        const totalScore = s_time + s_cost + s_carbon;

        return { 
            ...opt, t_time, t_cost, 
            carbonSaved: carbonSaved.toFixed(3),
            coins: (carbonSaved * 10).toFixed(1), 
            s_time, s_cost, s_carbon, 
            totalScore: parseFloat(totalScore.toFixed(1)) 
        };
    });

    processedData.sort((a, b) => b[sortCriteria] - a[sortCriteria]);

    const tbody = document.getElementById('resultBody');
    tbody.innerHTML = '';
    processedData.forEach((opt, index) => {
        let flowHtml = `<div class="route-details">` + opt.segments.map((seg, i) => 
            `<span class="seg-tag"><i class="fas fa-${ICONS[seg.type]}"></i> ${seg.desc}</span>` + 
            (i < opt.segments.length - 1 ? `<i class="fas fa-chevron-right seg-arrow"></i>` : "")
        ).join("") + `</div>`;

        tbody.innerHTML += `<tr>
            <td>
                <div style="font-size:1.1rem; font-weight:bold;">${opt.name}</div>
                ${index === 0 ? '<span class="recommended-badge">首選方案</span>' : ''}
                ${flowHtml}
            </td>
            <td data-label="時間 / 費用">
                <div>${opt.t_time} min</div>
                <div style="color:#64748b">$${opt.t_cost}</div>
            </td>
            <td data-label="減碳量 / 碳幣">
                <div style="color:var(--success)">${opt.carbonSaved} kg</div>
                <div class="coin-plus">+${opt.coins} 點</div>
            </td>
            <td data-label="各項得分詳情">
                <div class="score-info">時間分: ${opt.s_time}</div>
                <div class="score-info">金錢分: ${opt.s_cost}</div>
                <div class="score-info">低碳分: ${opt.s_carbon.toFixed(1)}</div>
            </td>
            <td data-label="綜合評分" style="color:var(--primary); font-weight:bold; font-size:1.2rem;">${opt.totalScore}</td>
        </tr>`;
    });
}

updateUI();
</script>
</body>
</html>